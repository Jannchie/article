---
title: 反爬虫技术科普
updatedAt: 2021-01-20 01:20
---
如果我想要绘制出我的粉丝数变化曲线，我只要每隔一段时间刷新一下网页，把我的粉丝数和当下时间抄录进 表格 就可以绘制成图形。

这一系列动作，非常机械简单无脑。程序员总是希望能够解放人类，让计算机去自动完成简单的任务。这样的一种，发送请求，获取数据，再保存下来的程序就叫做**爬虫**。

我可以下一个断言：这其实是最实用的技术，之一。同时这种技术也是最简单的。我们要做的是写一个客户端，它发送请求给服务器，服务器根据请求返回数据。

理论上你可以编写爬虫，获取一切你能看得到的数据。

但现实往往是，服务器会设置重重障碍，不希望你能爬取他的数据。

一方面有人写的爬虫有问题，占用了太多的资源。另一方面爬虫不公平，他可以用来抢火车票票。比如我曾经就被爬过，每天向我的服务器发送几百万个请求，服务器直接爆炸，流量费也直接爆炸，一觉醒来，房子没了。因此需要一种方式来防御爬虫。所以今天呢，主要就来和大家交流一下反爬虫技术。

## 检测爬虫

反爬虫技术的一种方式是：添加一种机制，识别客户端究竟是真人操作还是程序发起的请求。

最简单的方式是验证请求头。其实每一个被发送的请求都会标记自己是什么客户端发起的。而默认情况下，爬虫程序的请求头和其他请求头是不一样的。比如你用 Python 的 Requests 库的话，user-agent 就会带有相应的标记，告诉服务器这是程序而不是浏览器发起的。然而这个字段并不可靠。只需要一行代码就可以伪造成和普通用户一样的数据，所以没有什么效果。用这种方式唯一的好处就是不会误伤。毕竟正经人不会瞎改请求头。许多网站的反爬虫体系中都包含请求头的验证，比如知乎。

另外也可以根据 IP 地址来反爬虫。大部分长期的爬虫会部署在云服务器上，而从 IP 地址可以很轻松地判断爬虫是不是从服务器上发起的，服务器一检查，这个 IP 居然来自于阿里云，直接封了，一封一个准。但如果爬虫部署在其他机器上就无法判断了。

因此最常用也最有效的方法是检测访问频率，一个 IP 访问频率到了阈值，那么就封掉这个 IP。但这样也有一个缺点，因为现在 IPv6 还没有普及，一个IP地址都是很多人公用的。如果住在宿舍里，有一个舍友搞骚操作被封了，整个宿舍一起遭殃，这是很容易误封的一种操作。

## 加密数据

还有一种策略，是加密数据。它不专注于识别爬虫，而是增加爬虫程序编写的难度。事实上各大公司都应用了数据加密。比如将数字编号转换成毫无意义的字符串。其实这是一个大工程。这波操作增加了系统的复杂度，APP端、Web端、服务端都需要迎合这个新的系统做出修改。但是事实证明这波操作没有什么意义。仅仅几小时就被民间大神找到了转换公式，投入的工时变成了完全的浪费。

这还算比较难的加密，业界有些公司还在使用很小儿科的加密方式，就算不需要什么信息安全素养也能破解。比如百度指数。他的加密是这样的，在某个请求之中，服务器会返回一串神秘代码，类似`LjIpG6QRKw50dON8,7+%0592.64-31`, 而在另外一个请求之中返回一大串被加密过的数据。实际上，之前的神秘代码是一个对照表，前面一半是密文，后面一半是它的译文。用这个密码表就可以轻松地吧乱码翻译成真实数据。

相比之下，字节跳动的加密要恶心很多。字节跳动系的产品采用的是前端生成签名的机制。输入url和参数，经过一个层层套娃的算法，然后输出一个签名。根据请求的不同，这个签名也会有所不同。这对爬虫开发人员的前端水平有一定的要求，要通过比较繁琐的方式截取出签名生成的代码，在 JavaScript 环境中计算出签名。这依旧不是无懈可击的，有详细的技术博客介绍怎么生成签名。

## 混淆数据

还有一种策略是混淆数据。这种方式更有意思一些。这种技术并不是干掉爬虫，而是喂给爬虫虚假的数据。

其中有一种很神奇的方式。它给所有人的都是错误的数据，但是用人的肉眼去看，数据的显示却是正确的。比如服务器发来 1234，显示出来居然是 3142。其中的奥妙在于客户端使用了特殊的字体。这个字体就很奇葩，它把 1 写成 3 的样子，如果你看纯数据，那就是 1，但显示出来，它是 3。只有在服务方特别提供的字体下看到的才是正确的数字。这种方式找到了计算机和普通用户的一个不同之处，那就是计算机只会处理纯数据，而不会真的去观看数据呈现出来的样子。

虽然这种方式很有趣，但也不太有用。如果被发现了，也很容易被攻破。只要获取相应的字体文件，就能还原出正确的映射关系。

## 全自动区分计算机和人类的公开图灵测试

我们可以看到，只要是反爬虫策略，只要愿意去研究，都是能攻破的，而下面介绍的这个技术才是真的大杀器。它的名字是“全自动区分计算机和人类的公开图灵测试”，大家对这个名词可能比较陌生，但大家都知道他的俗称，那就是验证码。我知道大家都不喜欢验证码这种东西，他影响用户的使用体验。但这确实是抵御爬虫的终极手段。想要破解验证码，需要最前沿的技术，比如类似图中所示的验证码，首先需要计算机视觉技术识别出问题信息，再通过自然语言处理理解内容，再识别每张图所呈现的内容。爬虫程序明明是最简单的程序，但是它也能涉及到最尖端的技术。这也挺有意思的。

## 结语

我大致和大家讨论了几种我见过的爬虫和反爬虫的套路。这种攻防不断技术升级，有一种道高一尺，魔高一丈的感觉。其实爬虫技术是很难被彻底杜绝的。进攻方需要耗费时间精力和金钱面对防御方的反制手段，而防御方需要尽可能提高进攻方的成本。我曾经运营了一个网站，应用了一些爬虫相关的技术。目睹了一个网站是怎么从几乎不设防，到如今动不动就 412，甚至有时候会误伤普通用户。其实对于野生开发者来说，技术上的问题都很难难住他们。但每当这种反爬手段健壮一层，那些开发者的热情就冷淡一分。爬虫的编写者大多是应用自己学到的技术，方便自己也方便他人。并不是所有开发者都有动机，或者胆量，去拿这些数据牟利。其实国内外也有很多平台愿意开放自己的 API，提供开发者正规的渠道去增强他们的应用程序。我希望有一天，这种开放的精神也能在这里延续。
